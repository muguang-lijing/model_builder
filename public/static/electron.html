<!DOCTYPE html>
<html>

<head>
        <meta charset="UTF-8">
        <title>Hello World!</title>
        <link rel="stylesheet" href="./css/iview.css">
        <link rel="stylesheet" href="./css/style.css">


</head>

<body style="-webkit-app-region: drag">
        <div id='app'class = 'tbody'>
                <div class="Initialization" v-if="initializationshow">
                        <h1 class='title'>Create model</h1><br>
                        <h1>高效的整套模型创建解决方案</h1><br>
                        <i-Button id="select-directory" @click="openfile">选择模型目录</i-Button>
                </div>
                <div v-if="!initializationshow"class = 'tbody'>
                        <div class='left'>
                                <div>
                                        <h1>模型编辑</h1>
                                </div>
                                <div class='modles'>
                                        <div v-for = "name in models.table" @click = "modinfo(name)">
                                                <Icon type="document-text"></Icon>
                                                <h5>{{name}}</h5>
                                        </div>

                                </div>
                        </div>
                        <div class='center'>
                                <div class='header'>
                                        <p>目录 : <span> <a @click="openfile"> {{url}}</a></span></p>
                                        <i-Button type="primary" size="small" @click="button.add = true">+</i-Button>
                                        <Modal v-model="button.add" title="创建模型" @on-ok="" @on-cancel="cancel">
                                                <div>
                                                        <table>
                                                                <tr>
                                                                        <td>模型名称： </td>
                                                                        <td>
                                                                                <i-Input v-model="models.name" placeholder="请输入..." style="width: 300px"></i-Input>
                                                                        </td>
                                                                </tr>
                                                                <tr>
                                                                        <td></td>
                                                                        <td><span>*模型必须使用英文名称，否则会创建失败</span></td>
                                                                </tr>
                                                        </table>
                                                </div>
                                        </Modal>
                                </div>
                                <div class='content'>
                                     
                                        <Card :bordered="false" style= 'width:100%' >
                                                <p slot="title">模型创建</p>
                                                <i-Table  :height = 'getTabH'size = "small" w class = 'table' :columns="columns" :data="models.model"></i-Table>
                                        </Card>
                                        
                                </div>
                        </div>
                </div>
        </div>
</body>

</html>

<script type="text/javascript" src="./js/vue.js"></script>
<script type="text/javascript" src="./js/iview.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue-resource@1.3.4"></script>
<script type='text/javascript'>
        const ipc = require('electron').ipcRenderer
        new Vue({
                el: '#app',
                data: {
                        url: "www/dir/models",
                        ipc: ipc,
                        initializationshow: false,
                        button: {
                                add: false,
                        },
                        models: {
                                name: '',
                                table: [],
                                model:[],
                        },
                        width:0,
                        height:0,
                        columns:[
                                {
                                        type: 'expand',
                                        width: 20,
                                        align:'right',
                                        render: (h, params) => {
                                        return h(expandRow, {
                                                        props: {
                                                                row: params.row
                                                        },
                                                        style: {
                                                                'cursor':'pointer',
                                                        }
                                                })
                                        }
                                },
                                {
                                        width:'120',
                                        title: '名称',
                                        key: 'key',
                                        
                                 
                                },
                                {
                                        title: '类型',
                                        key: 'type',
                                        width:'150px',
                                        render:(h,params) =>{
                                                var str = "";
                                                var flag = true;
                                                var num = 0;
                                                var data = params.row.type.ps;
                                                show(data);
                                                return str;
                                                function show(data){
                                                        num++;
                                                        if(typeof data[0] === 'object'){
                                                                flag = false;
                                                                str +="ARRAY("+data[0].name+"(";
                                                                show(data[0].ps);
                                                        }else{
                                                                if(flag == true){                              
                                                                    str = params.row.type.name+"("
                                                                }

                                                                for(var item of data){
                                                                        str+=" "+item+" "          
                                                                }
                                                                for(var i=0; i<num; i++){
                                                                        str+=")"
                                                                }
                                                               
                                                        }
   
                                                }                                             
                                        }
                                },
                                {
                                        title: '备注描述',
                                        key: 'comment',
                                        ellipsis:'true',
                                   
                                },
                                {
                                        width:'100px',
                                        title: '默认值',
                                        key: 'defaultValue',
                                    
                                },
                                {
                                        width:'30',
                                        title: '主键',
                                        key: 'primaryKey',
                                        render:(h,params)=>{
                                                if(params.row.primaryKey){
         
                                                        return h('div', [
                                                                h('p', {
                                                                style: {
                                                                        color:'green'
                                                                },
                                                                }, '✔'),
                                                        ]);
                                                }else{
                                                    
                                                        return h('div', [
                                                                h('p', {
                                                                style: {
                                                                        color:'red'
                                                                },
                                                                }, '✘'),
                                                        ]);
                                                }
                                        }
                                      
                                },
                                {
                                        width:'30',
                                        title: '为空',
                                        key: 'allowNull',
                                        render:(h,params)=>{
                                                if(params.row.allowNull){
         
                                                        return h('div', [
                                                                h('p', {
                                                                style: {
                                                                        color:'green'
                                                                },
                                                                }, '✔'),
                                                        ]);
                                                }else{
                                                    
                                                        return h('div', [
                                                                h('p', {
                                                                style: {
                                                                        color:'red'
                                                                },
                                                                }, '✘'),
                                                        ]);
                                                }
                                        }
                                 
                                },
                                {
                                        width:'30',
                                        title: '独一',
                                        key: 'allowNull',
                                        render:(h,params)=>{
                                                if(params.row.allowNull){
         
                                                        return h('div', [
                                                                h('p', {
                                                                style: {
                                                                        color:'green'
                                                                },
                                                                }, '✔'),
                                                        ]);
                                                }else{
                                                    
                                                        return h('div', [
                                                                h('p', {
                                                                style: {
                                                                        color:'red'
                                                                },
                                                                }, '✘'),
                                                        ]);
                                                }
                                        }
                                  
                                },
                                {
                                        title: '操作',
                                        key: 'key',
                                        width: 60,
                                 
                                        render: (h, params) => {
                                                return h('div', [
                                                        h('a', {
                                                        props: {
                                                                type: 'ghost',
                                                                size: 'small'
                                                        },
                                                        style: {
                                                                marginRight: '5px',
                                                                color:''
                                                        },
                                                        on: {
                                                                click: () => {
                                                                this.show(params.index)
                                                                }
                                                        }
                                                        }, '查看'),
                                                        h('a', {
                                                        props: {
                                                                type: 'ghost',
                                                                size: 'small'
                                                        },
                                                        on: {
                                                                click: () => {
                                                                this.remove(params.index)
                                                                }
                                                        }
                                                        }, '删除')
                                                ]);
                                        }
                                }
                        ]
                },
                computed:{
                        getTabH:function(){
                                return this.height - 200;
                        }
                },
                methods: {
                        openfile: function () {
                                console.log(this.ipc);
                                this.ipc.send('open-file-dialog');
                        },
                        

                        selectdir: function (path) {
                                
                                this.$http.post("/main/set_models_dir",{models_dir:path[0]}).then(res => {
                                        if(res.body.out.status){
                                                this.$Notice.open({
                                                        title: '选择模型目录成功',
                                                        desc:""
                                                });
                                                this.url = path[0];
                                                this.readfile();
                                                this.initializationshow = false;
                                        }
                                }).catch(err =>{
                                        this.$Notice.error({
                                                title: '选择模型目录失败',
                                                desc:""
                                        });
                                })
                        },

                        readfile:function(){
                                this.$http.get("/main/model_list").then(res => {
                                        if(!res.body.err.code){
                                                this.$Notice.open({
                                                        title: '读取目录模型成功',
                                                        desc:""
                                                });
                                                this.models.table = res.body.out.datas;
                                                console.log(JSON.stringify(this.models.table,0,4));
                                        }
                                })
                        },

                        modinfo:function(name){
                                this.$http.get("/main/model_info?model_name="+name).then(res => {
                                        this.models.model = res.body.out.infos,0,4;
                                }).catch(err =>{
                                        this.$Notice.error({
                                                title: '读读取模型失败',
                                                desc:""
                                        });
                                })
                        }
                },
                created() {
                        var self = this;
                        this.ipc.on('selected-directory', function (event, path) {
                                self.selectdir(path);
                        })
                        this.selectdir(['/home/zm/www/djk/models']);
                        this.width = document.documentElement.clientWidth || document.body.clientWidth;
                        this.height = document.documentElement.clientHeight || document.body.clientHeight;
                        document.getElementsByTagName('body')[0].style.height = this.height+'px'
                        var self = this;
                        window.onresize = function(){
                                self.width = document.documentElement.clientWidth || document.body.clientWidth;
                                self.height = document.documentElement.clientHeight || document.body.clientHeight;
                                document.getElementsByTagName('body')[0].style.height = self.height+'px'
                        }
                }
        })

</script>
